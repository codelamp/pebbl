async("theory.plugins.expreg",["theory"],function(t){t=t||{};t.plugins=t.plugins||{},t.plugins.expreg=function(e){var s=function(t,e){if(!(this instanceof s))return"string"==typeof this?new s(t,String(this)):new s(t,e);if(this.exp=s.expression(t),!this.exp)throw new Error("unable to parse ExpReg expression.");this.source=e?e:"",this.matches=[],this.matched=!1,this.finished=!1,this.reversed=!1};return t.extend(s,e),s.unwrapPattern=new RegExp("^([^a-z0-9s])(.+?)\\1([gimy]{0,4})$","i"),s.expression=function(t){var e,i={};return(e=s.unwrapPattern.exec(String(t)))?(i.string=e[2],i.flags=e[3],i.flagsNoGlobal=i.flags.replace("g",""),i.flagsGlobal=i.flags.replace("g","")+"g",i.single=new RegExp(i.string,i.flagsNoGlobal),i.multiple=new RegExp(i.string,i.flagsGlobal),i):null},s.quote=function(t){return t.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&")},s.prototype.haystack=function(t){return arguments.length&&"string"==typeof t?(this.source=t,this.matched=!1,this):this.source},s.prototype.item=function(t){return 0==arguments.length||void 0===t||null===t?this.matches:t<0?this.matches[this.matches.length+t]:t<this.matches.length?this.matches[t]:null},s.prototype.reset=function(){this.exp.single.lastIndex=0,this.exp.multiple.lastIndex=0},s.prototype.find=function(){if(this.matches.length=0,this.matched=!1,this.finished)return this;var t=this.exp.multiple.exec(this.source);return t?(this.matched=!0,this.matches[this.matches.length]={value:t[0],groups:t,offset:this.exp.multiple.lastIndex-t[0].length,end:this.exp.multiple.lastIndex}):this.finished=!0,this},s.prototype.finding=function(){return this.find(),this.matched},s.prototype.findAndReplace=function(t,e){var s=this.find().replace(t,e);return(!this.finished||!e.emptyFinish)&&s},s.prototype.findAll=function(){this.matches.length=0,this.matched=!1,this.reset();for(var t;t=this.exp.multiple.exec(this.source);)this.matches[this.matches.length]={value:t[0],groups:t,offset:this.exp.multiple.lastIndex-t[0].length,end:this.exp.multiple.lastIndex};return this.matched=!0,this},s.prototype.replace=function(t,e){var s,i,h=this,n=0;return this.finished?this:(this.matched||this.find(),this.matched&&(match=this.matches[0],i=this.exp.multiple.lastIndex,s=this.source.replace(this.exp.multiple,function(e){var s=arguments[match.groups.length],i=void 0;return s===match.offset&&(is.string(t)?i=t:is.array(t)?i=t.shift():is.callable(t)&&(i=t.call(h,arguments,h))),void 0!==i?(n=i.length-e.length,i):e}),this.exp.multiple.lastIndex=i+n),e&&e.returnResult?s:(this.source=s,this))},s.prototype.replaceAll=function(t,e){var s,i=this,h=0;return this.matched||this.findAll(),this.matches.length&&(is.string(t)?s=this.source.replace(this.exp.multiple,t):is.array(t)?(t=t.slice(),s=this.source.replace(this.exp.multiple,function(e){h%=t.length;var s=t[h++];return is.callable(s)?s.call(i,arguments,i):s})):is.callable(t)&&(s=this.source.replace(this.exp.multiple,function(){return t.call(i,arguments,i)}))),e&&e.returnResult?s:(this.source=s,this)},s.prototype.replaceIter=function(t,e){var s,i=this;return e||(e={}),e.emptyFinish=!0,s=function(s){return!!i.findAndReplace.apply(i,[arguments.length?s:t,e])&&i.source},s.reset=function(){i.reset()},s},s.prototype.replaceNth=function(t,e,s){var i,h=this,n=0;t<this.matches.length&&(i=this.matches[t],result=this.source.replace(this.exp.multiple,function(t){var s=arguments[i.groups.length],r=void 0;return s===i.offset&&(is.string(e)!==!1?r=e:is.array(e)?r=e.shift():is.callable(e)&&(r=e.apply(h,arguments))),void 0!==r?(n=r.length-t.length,i.value=r,i.end=i.offset+i.value.length,r):t}),this.reversed?this.shiftMatches(0,t,n):this.shiftMatches(t,this.matches.length,n),this.source=result)},s.prototype.shiftMatches=function(t,e,s){for(var i=t;i<e;i++)this.matches[i]&&(this.matches[i].offset+=s,this.matches[i].end+=s)},s.prototype.each=function(t){if(this.matched||this.findAll(),this.matches.length){var e,s=this.matches.length;for(e=0;e<s;e++)t.call(this,this.matches[e],e,this)}return this},s.prototype.map=function(t){var e=[];if(this.matched||this.findAll(),this.matches.length){var s,i=this.matches.length;if(void 0===t&&(t=1),t.call)for(s=0;s<i;s++)e[s]=t.call(this,this.matches[s],s,this);else for(s=0;s<i;s++)this.matches[s]&&void 0!==this.matches[s].groups[t]&&(e[s]=this.matches[s].groups[t])}return e},s.prototype.wrap=function(t,e){return this.replace(function(s){return t+s[0]+e}),this},s.prototype.reverse=function(){return this.matched||this.findAll(),this.matches.reverse(),this.reversed=!this.reversed,this},s.prototype.log=function(t,e){return this.each(function(t,e){console.log(e,t)}),this},s.prototype.valueOf=function(){return this.matched?1:0},String.prototype.ExpReg=s,s}(t.plugins.expreg)});