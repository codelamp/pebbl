async("theory.plugins.broadcast",["theory"],function(e){e=e||{};e.plugins=e.plugins||{},e.plugins.broadcast=function(s){var t=e.base.mix(s||{},{init:function(){t.id=t.guid(),t.messageKey.keysize=t.messageKey(t.id,t.id).length,t.replyKey.keysize=t.replyKey(t.id,t.id,t.id).length,window.addEventListener("storage",t.storageChanged,!1)},sendMessage:function(e){var s;if(!e&&(e={}),!e.content&&(e.content=""),!e.callback&&(e.callback=!1),!e.wait&&(e.wait=!1),s={},s.replies=[],s.message={},s.message.oid=t.id,s.message.mid=t.guid(),s.message.key=t.messageKey(s.message.oid,s.message.mid),s.message.content=e.content,s.message.occured=(new Date).getTime(),e.callback)switch(s.callback=function(){t.clearMessage(s.message),window.removeEventListener("broadcastreply",s.listener),e.callback.call(s.message,s.replies)},s.listener=function(t){t.data&&(s.replies.push(t.data),"first"===e.wait&&s.callback())},e.wait){case"none":s.callback();break;case"first":window.addEventListener("broadcastreply",s.listener);break;default:this.isNumber(e.wait=0+e.wait)&&(window.addEventListener("broadcastreply",s.listener),s.tid=setTimeout(s.callback,e.wait))}else setTimeout(function(){t.clearMessage(s.message)},100);window.localStorage.setItem(s.message.key,JSON.stringify(s.message))},isNumber:function(e){return!isNaN(e)},clearMessage:function(e){e&&e.key&&delete window.localStorage[e.key]},triggerEvent:function(e,s,t,a){var n,i;i=document.createEvent?document.createEvent("HTMLEvents"):document.createEventObject(),i.initEvent?i.initEvent(s.type,t,a):i.eventType=s.type;for(n in s)"type"!=n&&(i[n]=s[n]);e.dispatchEvent?e.dispatchEvent(i):e.fireEvent("on"+i.eventType,i)},replyToMessage:function(e){var s,a=this;a.mid?(s={},s.message={},s.message.oid=t.id,s.message.rid=a.oid,s.message.mid=t.guid(),s.message.key=t.replyKey(s.message.oid,s.message.rid,s.message.mid),s.message.content=e,s.message.occured=(new Date).getTime(),window.localStorage.setItem(s.message.key,JSON.stringify(s.message))):console.warn("unable to reply, no original!",a.key)},storageChanged:function(e){var s={};if(e.key&&e.newValue&&(s.key=t.parseKey(e.key))){if(s.key.rid===t.id)return s.message=JSON.parse(e.newValue),t.triggerEvent(window,{type:"broadcastreply",data:s.message}),void t.clearMessage(s.message);if(s.key.rid)return;s.key.oid!==t.id&&(s.message=JSON.parse(e.newValue),s.message.reply=function(){return t.replyToMessage.apply(s.message,arguments)},t.triggerEvent(window,{type:"broadcastmessage",data:s.message}))}},messageKey:function(e,s){return"bm:"+e+":"+s},replyKey:function(e,s,t){return"bm:"+e+":"+s+":"+t},parseKey:function(e){if("bm:"===e.substr(0,3)){if(e.length===t.replyKey.keysize)return{oid:e.substr(4,16),rid:e.substr(20,16),mid:e.substr(37,16)};if(e.length===t.messageKey.keysize)return{oid:e.substr(4,16),rid:null,mid:e.substr(20,16)}}},guid:function(){return""+(65536*(1+Math.random())|0).toString(16).substring(1)+(65536*(1+Math.random())|0).toString(16).substring(1)+(65536*(1+Math.random())|0).toString(16).substring(1)+(65536*(1+Math.random())|0).toString(16).substring(1)}});return window.broadcastMessage=function(e){return t.sendMessage(e)},t.init(),t}(e.plugins.broadcast)});