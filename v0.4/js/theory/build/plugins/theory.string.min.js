async("theory.plugins.string",["theory"],function(e){var t=e=e||{};return e.plugins=e.plugins||{},!String.prototype.contains&&(String.prototype.contains=function(e){return this.indexOf(e)!=-1}),!String.prototype.indexOfEscapable&&(String.prototype.indexOfEscapable=function(e,t,n){var s,r,i=(t||0)-1;for(!n&&(n="\\");(s=i=this.indexOf(e,i+1))!=-1;){for(r=0;this.charAt(--s)===n;)r++;if(!(r&&1&r))break}return i}),!String.prototype.charIs&&(String.prototype.charIs=function(e,t,n){return t<-1&&(t=e.length+t),n.indexOf(e.charAt(t))!=-1}),!String.prototype.trim&&(String.prototype.trim=function(e){return e.replace(/^\s+|\s+$/g,"")}),e.plugins.string=e.base.mix(e.plugins.string,{theory:{prep:function(e){return e.instructions.processGroup=e.instructions.processGroup.bind(e),e.instructions.processItem=e.instructions.processItem.bind(e),e}},instructionSets:{},i:{},prep:function(e,t){return this.source=e,this.config=t||{},this.i=Object.create(this.i),this},parse:function(e,t){if(t||(t=this.instructionSets[e]))return this.instructions.processGroup(t,"default",this.tree={string:this.source.trim()});throw new Error("unknown instruction set "+e)},instructions:t.method({method:function(e,t){return arguments.length>1?(this.instructionSets[e]=t,this):this.instructionSets[e]},attributes:{processGroup:function(e,t,n){var s,r,i,o="string"==typeof t?e[t]:t;if(o&&o.content)if(n.children)for(s=n.children,r=0,i=s.length;r<i;r++)this.processGroup(e,t,s[r]);else for(s=o.content,r=0,i=s.length;r<i;r++)this.processItem(e,s[r],n);return n},processItem:function(e,n,s,r){var i,o,a,c,d,u,m,g,l,p,h,f,k,b;if(!r&&(r={dividerOffset:0}),n.divide||n.ranges){if(!n.compiled){if(n.compiled={},n.ranges){for(n.compiled.ranges={starts:t.matchbook.create(),ends:t.matchbook.create()},o=n.ranges,d=0,c=o.length;d<c;d++)(a=o[d])&&(l=e[a])&&(l.start&&n.compiled.ranges.starts.add(l.start,l),l.end&&n.compiled.ranges.ends.add(l.end,l));n.compiled.ranges.starts.compile(),n.compiled.ranges.ends.compile()}if(n.divide)for(n.compiled.dividers=[],o=n.divide,d=0,c=o.length;d<c;d++){if(h=t.matchbook.create(),o[d].join)for(u=o[d],m=0,g=u.length;m<g;m++)(a=u[m])&&(l=e[a])&&l.token&&h.add(l.token,l);else(a=o[d])&&(l=e[a])&&l.token&&h.add(l.token,l);n.compiled.dividers.push(h.compile())}}if(p=0,f=null,b=[],n.compiled){o=n.compiled.dividers||[],d=r.dividerOffset,c=o.length;do{for(u=s.string,m=0,g=u.length;m<g;m++)o[d]&&!k&&(i=o[d].compare(u,m))?(l=o[d].userdata(i),l=l[0],!f&&(f={type:l.name,children:[],token:i,dividers:o,divider:d}),f.children.push(f.lastChild={type:l.makes,string:u.substring(p,m)}),p=m+i.length,m+=i.length-1):n.compiled.ranges&&(k?(i=n.compiled.ranges.ends.compare(u,m))&&this.ranges.hasEnd(k,i)?(this.ranges.chooseEnd(k,i),k.metrics&&(k.metrics.innerEnd=m,k.metrics.outerEnd=m+i.length,k.outer=u.substring(k.metrics.outerStart,k.metrics.outerEnd),k.string=u.substring(k.metrics.innerStart,k.metrics.innerEnd)),k=b.pop(),m+=i.length-1):(i=n.compiled.ranges.starts.compare(u,m))&&(l=n.compiled.ranges.starts.userdata(i),b.push(k),k=this.ranges.make(l),m+=i.length-1):s.ranges&&s.ranges.lookup[m]?m=s.ranges.lookup[m].metrics.innerEnd:(i=n.compiled.ranges.starts.compare(u,m))&&(l=n.compiled.ranges.starts.userdata(i),!s.ranges&&(s.ranges={lookup:{},list:[]}),k=this.ranges.make(l,{outerStart:m,innerStart:m+i.length}),s.ranges.list.push(k),s.ranges.lookup[m]=k,m+=i.length-1));d++}while(!f&&d<c);if(f&&f.lastChild){if(f.children.push(f.lastChild={type:f.lastChild.type,string:s.string.substring(p,s.string.length)}),f.divider+1<f.dividers.length)for(u=f.children,m=0,g=u.length;m<g;m++)this.instructions.processItem(e,n,u[m],{dividerOffset:f.divider+1});for(u=f.children,m=0,g=u.length;m<g;m++)u[m].type.join&&(u[m].type=u[m].type[m]),this.instructions.processGroup(e,u[m].type,u[m]);!s.children&&(s.children=[]),s.children.push(f),delete f.divider,delete f.dividers,delete f.lastChild,f=null}else if(s.ranges&&s.ranges.list)if(s.ranges.list.length>1||1===s.ranges.list.length&&s.ranges.list[0].outer&&s.ranges.list[0].outer.length<s.string.length)for(s.children=[f={type:"combination",children:[]}],p=0,s.ranges.list.push(null),o=s.ranges.list,d=0,c=o.length;d<c;d++)(l=s.string.substring(p,o[d]?o[d].metrics.outerStart:s.string.length))&&f.children.push({type:"string",string:l}),o[d]&&(f.children.push(o[d]),this.instructions.processGroup(e,o[d].type,o[d]),p=o[d].metrics.outerEnd);else(o=s.ranges.list[0])&&(s.children=[o],this.instructions.processGroup(e,o.type,o));else n.makes&&this.instructions.processGroup(e,n.makes,s);delete s.ranges}}return s}}}),ranges:{make:function(e,t){for(var n={start:[],end:[],type:[]},s=0;s<e.length;s++)n.start.push(e[s].start),n.end.push(e[s].end),n.type.push(e[s].name);return t&&(n.metrics=t),n},hasEnd:function(e,t){return e.end.indexOf(t)!=-1},chooseEnd:function(e,t){var n=e.end.indexOf(t);return e.start=e.start[n],e.type=e.type[n],e.end=e.end[n],e}}}),e.plugins.string.instructions("t-key",{default:{content:[{ranges:["squareOptional","square"]}]},squareOptional:{name:"squareOptional",start:"[",end:"]?",content:[{divide:["commas"],makes:"item"}]},square:{name:"square",start:"[",end:"]",content:[{divide:["commas"],makes:"item"}]},commas:{name:"commas",token:",",makes:"item"},item:{name:"item",content:[{divide:["ors","colon"]}]},ors:{name:"ors",token:"|",makes:"item"},colon:{name:"colon",token:":",makes:["item","name"]}}),e.plugins.string.instructions("opn",{default:{content:[{divide:["segments"],makes:"segment",ranges:["squote","dquote","square","angle","bubble"]}]},bubble:{name:"bubble",start:"(",end:")",content:[{divide:["spaces","segments"],makes:"segment",ranges:["squote","dquote","square","angle","bubble"]}]},square:{name:"square",start:"[",end:"]",content:[{divide:["comparison"],makes:"attribute",ranges:["squote","dquote"]}]},squote:{name:"single-quote",start:"'",end:"'"},dquote:{name:"double-quote",start:'"',end:'"'},angle:{name:"angle",start:"<",end:">"},ands:{name:"ands",token:"&",makes:"and"},ors:{name:"ors",token:"|",makes:"or"},spaces:{name:"spaces",token:" ",makes:"spaced"},segments:{name:"segments",token:"/",makes:"segment"},comparison:{name:"comparison",token:["!=","$=","^=","="],makes:["attribute","value"]},assignment:{name:"assignment",token:[":="],makes:["assignee","value"]},commas:{name:"commas",token:",",makes:"comma"},spaced:{name:"spaced"},segment:{name:"segment",content:[{divide:["ands","ors","commas","assignment","comparison"],ranges:["squote","dquote","square","angle","bubble"]}]},comma:{name:"comma",content:[{divide:["assignment","comparison"],ranges:["squote","dquote","square","angle","bubble"]}]},assignee:{name:"assignee",content:[{divide:["commas"],ranges:["squote","dquote"]}]},attribute:{name:"attribute",content:[{divide:["commas"],ranges:["squote","dquote"]}]},value:{name:"value",content:[{divide:["commas"],ranges:["squote","dquote"]}]}}),t.opn=function(e){var n=t.string(e).parse("opn");return n.segments=function(){var e=0,t=this.children[0].children;return{next:function(){return t[e++]}}},n},t.opn.wrap=function(e){return{string:function(){return e.string},strings:function(){for(var t=[],n=0,s=e,r=s.length;n<r;n++)t.push(s[n].string);return t}}},t.string=function(e,t){return this.plugins.string.create(e,t)},e.plugins.string});